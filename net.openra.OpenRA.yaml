app-id: net.openra.OpenRA
runtime: org.freedesktop.Platform
runtime-version: '19.08'
sdk: org.freedesktop.Sdk
command: openra-ra-wrapper
rename-desktop-file: net.openra.OpenRA.openra-ra.desktop
rename-icon: net.openra.OpenRA.openra-ra
finish-args:
  - --socket=x11
  - --share=ipc
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --share=network
  - --persist=.openra
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /lib/pkgconfig
  - /share/man
cleanup-commands:
  - >
    find /app/bin -type f -not -name 'openra*' -not -name mono -not -name mono-sgen
    -not -name cert-sync -not -name python -print0 | xargs -0 rm -rf
  - find /app/lib/mono -mindepth 1 -maxdepth 1 -not -name gac -not -name 4.5 -print0 | xargs -0 rm -rf
  - >
    find /app/lib/mono/gac -mindepth 1 -maxdepth 1 -not -name System -not -name System.Core
    -not -name System.Xml -not -name System.Configuration -not -name I18N -not -name I18N.CJK
    -not -name I18N.MidEast -not -name I18N.Other -not -name I18N.Rare -not -name I18N.West
    -not -name Accessibility -not -name Mono.Cairo -not -name Mono.Posix -not -name Mono.CSharp
    -not -name System.Drawing -not -name System.Numerics -not -name Mono.Security -print0 | xargs -0 rm -rf
  - find /app/lib/mono -type f -name '*.exe' -not -name cert-sync.exe -print0 | xargs -0 rm -rf
modules:
  - name: libgdiplus0
    sources:
      - type: archive
        url: https://download.mono-project.com/sources/libgdiplus/libgdiplus0-6.0.4.tar.gz
        sha256: b75c38c9765d5b3e2fb3da4435f169c732983878c0f94b8bf9012137022abf29

  - name: python
    buildsystem: simple
    build-commands:
      - install -d /app/bin
      - ln -s /usr/bin/python3 /app/bin/python

  - name: mono
    sources:
      - type: archive
        url: https://download.mono-project.com/sources/mono/mono-5.20.1.34.tar.bz2
        sha256: cd91d44cf62515796ba90dfdc274bb33471c25a2f1a262689a3bdc0a672b7c8b
    config-opts:
      - --disable-dependency-tracking
      - --without-mcs-docs
    cleanup:
      - '*.exe.*'
      - '*.pdb'
      - '*.xsd'
      - /lib/mono/4.5/Facades
      - /lib/mono/4.5/MSBuild
      - /lib/mono-source-libs
      - /share

  - name: msbuild
    sources:
      - type: file
        url: http://download.mono-project.com/repo/ubuntu/pool/main/m/msbuild/msbuild_16.4+xamarinxplat.2019.09.09.15.03-0xamarin5+ubuntu1804b1_all.deb
        sha256: 47804a0ff3b7531d3c5e1d7b733189354761e08593e6d927b868b3c3f219aef3
    cleanup:
      - '*'
    buildsystem: simple
    build-commands:
      - ar x msbuild_*.deb
      - tar xf data.tar.xz
      - sed -e 's|/usr/|/app/|g' -i usr/bin/msbuild
      - cp -a usr/. /app

  - name: lua51
    sources:
      - type: archive
        url: https://www.lua.org/ftp/lua-5.1.5.tar.gz
        sha256: 2640fc56a795f29d28ef15e13c34a47e223960b0240e8cb0a82d9b0738695333
      - type: patch
        path: lua51-cflags.patch
      - type: patch
        path: lua51-prefix.patch
      - type: patch
        path: lua51-so.patch
      - type: shell
        commands:
          - sed -e 's:llua:llua5.1:' -e 's:/include:/include/lua5.1:' -i etc/lua.pc
          - sed -r -e '/^LUA_(SO|A|T)=/ s/lua/lua5.1/' -e '/^LUAC_T=/ s/luac/luac5.1/' -i src/Makefile
          - mv doc/lua.1 doc/lua5.1.1
          - mv doc/luac.1 doc/luac5.1.1
    cleanup:
      - /bin
    buildsystem: simple
    build-commands:
      - make CFLAGS='-O2 -Wall -fPIC' linux
      - make TO_BIN='lua5.1 luac5.1' TO_LIB='liblua5.1.a liblua5.1.so liblua5.1.so.5.1
        liblua5.1.so.5.1.5' INSTALL_TOP='/app' INSTALL_INC='/app/include/lua5.1' TO_MAN='lua5.1.1
        luac5.1.1' INSTALL_MAN='/app/share/man/man1' install
      - install -Dm0644 etc/lua.pc /app/lib/pkgconfig/lua51.pc
      - ln -s liblua5.1.so /app/lib/liblua.so.5.1
      - ln -s liblua5.1.so /app/lib/liblua.so.5.1.5

  - name: OpenRA
    sources:
      - type: git
        url: https://github.com/OpenRA/OpenRA
        commit: a47969b31b66455ac6f61796b26c753f14bf5bcc
        branch: release-20191117
      - type: shell
        commands:
          - mkdir -p LocalNugetPackages
          - mkdir thirdparty/download
      - type: file
        path: nuget.config
      - type: file
        url: https://www.nuget.org/api/v2/package/StyleCop.Analyzers/1.1.118
        dest-filename: LocalNugetPackages/stylecop.analyzers.1.1.118.nupkg
        sha256: 0a30b57f9cf4b0fd7917a15e5ea2033ad64b1ea8239904f3a6c22b464c574442
      - type: file
        url: https://www.nuget.org/api/v2/package/SharpZipLib/1.1.0
        dest-filename: thirdparty/download/SharpZipLib.zip
        sha256: 0f4bb6666a67fde963d90f4a96fd68eb1d098ef55a936d6e712cea74d4b798ca
      - type: file
        url: https://nuget.org/api/v2/package/MaxMind.Db/2.0.0
        dest-filename: thirdparty/download/MaxMind.Db.zip
        sha256: 98595abd21c735fe8bb84911a7b254f5d37c910818411f8edded7378e3e7c181
      - type: file
        url: https://nuget.org/api/v2/package/NUnit/3.0.1
        dest-filename: thirdparty/download/NUnit.zip
        sha256: eb0b156b44142622d7cd573073d6dc925f8529f2860637325f5af85f94db423c
      - type: file
        url: https://nuget.org/api/v2/package/NUnit.Console/3.0.1
        dest-filename: thirdparty/download/NUnit.Console.zip
        sha256: 164ce9124d769ac994a79234e59ce51a21be5089e86210666abfef0791ade07f
      - type: file
        url: https://nuget.org/api/v2/package/Open.Nat/2.1.0
        dest-filename: thirdparty/download/Open.Nat.zip
        sha256: c532dee1478b4a7e28aa4797a5efc3f829a6bd0cc0af646aac001ce183f0e3e2
      - type: file
        url: https://nuget.org/api/v2/package/FuzzyLogicLibrary/1.2.0
        dest-filename: thirdparty/download/FuzzyLogicLibrary.zip
        sha256: ca8caf33637ae661dfdd5797589f034950d2fcb4f7192ee858830f6e2525df3f
      - type: file
        url: https://github.com/OpenRA/SDL2-CS/releases/download/20190907/SDL2-CS.dll
        dest-filename: thirdparty/download/SDL2-CS.dll
        sha256: b06c14a771d14cb37210f476dfd973d4e7d80d97f90566bd5bc78996ade4f7a0
      - type: file
        url: https://github.com/OpenRA/SDL2-CS/releases/download/20190907/SDL2-CS.dll.config
        dest-filename: thirdparty/download/SDL2-CS.dll.config
        sha256: 7d75ef450e1ceb3f61e77a0513b034a5bc2e754065182bc1bc9134ac664da6bd
      - type: file
        url: https://github.com/OpenRA/OpenAL-CS/releases/download/20190907/OpenAL-CS.dll
        dest-filename: thirdparty/download/OpenAL-CS.dll
        sha256: 4cc20a160107748a8e13dfc5e29f9daacf2675e4b302e066bfbe4a1be0596015
      - type: file
        url: https://github.com/OpenRA/OpenAL-CS/releases/download/20190907/OpenAL-CS.dll.config
        dest-filename: thirdparty/download/OpenAL-CS.dll.config
        sha256: 12704a902127e3f67e7d9a3e2331bf2d65e008b59ab96d132807add14e0f2a1c
      - type: file
        url: https://github.com/OpenRA/Eluant/releases/download/20160124/Eluant.dll
        dest-filename: thirdparty/download/Eluant.dll
        sha256: 218c4ea5424b44d746b5343563123beebc652fd9731967dfd49fed071b58df31
      - type: file
        url: https://nuget.org/api/v2/package/rix0rrr.BeaconLib/1.0.1
        dest-filename: thirdparty/download/rix0rrr.BeaconLib.zip
        sha256: ed4d44f176af53a2fcb31b35def9a5af4cd42bb3639bc2c458f843d991f074ec
      - type: archive
        url: https://geolite.maxmind.com/download/geoip/database/GeoLite2-Country_20191224.tar.gz
        dest: thirdparty/download/
        sha256: f2dccb2d086b02ffd71aa83d5e1e7f5d0dd79ba16292b6ec82a6ff41d426b33d
      - type: shell
        commands:
          - gzip thirdparty/download/GeoLite2-Country.mmdb
    buildsystem: simple
    build-commands:
      - touch thirdparty/download/GeoLite2-Country.mmdb.gz
      - make version
      - make
      - make prefix=/app install
      - make prefix=/app install-linux-shortcuts
      - make prefix=/app install-linux-mime

  - name: cert-sync-wrapper
    buildsystem: simple
    sources:
      - type: script
        commands:
          - cert-sync --user --quiet /etc/ssl/certs/ca-certificates.crt
          - exec openra-ra "$@"
        dest-filename: openra-ra-wrapper
      - type: script
        commands:
          - cert-sync --user --quiet /etc/ssl/certs/ca-certificates.crt
          - exec openra-cnc "$@"
        dest-filename: openra-cnc-wrapper
      - type: script
        commands:
          - cert-sync --user --quiet /etc/ssl/certs/ca-certificates.crt
          - exec openra-d2k "$@"
        dest-filename: openra-d2k-wrapper
    build-commands:
      - install -Dm0755 -t /app/bin openra-*-wrapper
      - sed -i 's/Exec=openra-[^ ]*/\0-wrapper/' /app/share/applications/openra-{ra,cnc,d2k}.desktop

  - name: export
    buildsystem: simple
    sources:
      - type: file
        path: net.openra.OpenRA.appdata.xml
    build-commands:
      - sed -i 's/Icon=openra/Icon=net.openra.OpenRA.openra/' /app/share/applications/openra-{ra,cnc,d2k}.desktop
      - |
        for f in /app/share/icons/hicolor/*/apps/openra-{ra,cnc,d2k}.* /app/share/applications/openra-{ra,cnc,d2k}.desktop /app/share/mime/packages/openra-{ra,cnc,d2k}.xml
        do
          mv "$f" "$(echo "$f" | sed 's/openra/net.openra.OpenRA.openra/')"
        done
      - install -Dm0644 -t /app/share/metainfo net.openra.OpenRA.appdata.xml
